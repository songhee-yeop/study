# 카프카 설치하기
- 아파치 설치 및 주키퍼 설치
## 2.1 환경설정

### 2.1.1 운영체제
- 대체로 리눅스 권장

### 2.1.2 자바 설치하기
- 자바 설치해!
### 2.1.3 
- 주키퍼는 설정 정보 관리, 이름 부여, 분산 동기화, 그룹 서비스를 제공하는 중앙화된 서비스
- 이 책에서는 주키퍼 웹사이트에서 다운 가능한 3.5.9 사용(현재 3.9.5)
1. 독립 서버 실행
    - 주키퍼는 기본적인 예제 설정 파일과 함께 배포
    - brew services start zookeeper
2. 주키퍼 앙상블
    - 고가용성 보장 위해 클러스터 단위로 작동하도록 설계된 앙상블
    - 홀수개의 서버 권장
    - 주키퍼가 요청에 응답하려면 앙상블멤버(쿼럼)의 과반 이상이 작동하고 있어야 한다.
    - 주키퍼 서버를 앙상블로 구성하기 위해
      - 각 서버는 공통된 설정 파일 사용. 이 설정 파일에는 앙상블에 포함된 모든 서버 목록 포함
      - 각 서버는 데이터 디렉토리에 자신의 ID번호를 지정하는 myid 파일을 가지고 있어야 한다.
~~~ myid 파일
tickTime=2000 #기본 단위
dataDir=/var/lib/zookeeper
clientPort=2181
initLimit=20 #팔로워가 리더와의 연결할수 있는 최대 시간(초기화 제한 시간)
syncLimit=5 # 팔로워가 리더와 연결할 수 있는 최대 시간(동기화 제한 시간)
server.1=zoo1.example.com:2888:3888
server.2=zoo2.example.com:2888:3888
server.3=zoo3.example.com:2888:3888 # server.{x}={hostname}:{peerPort}:{readerPort}
~~~

## 2.2 카프카 브로커 설치하기
- brew install kafka
- brew services start kafka
- kafka-topics --create --topic test-topic --bootstrap-server localhost:9092 --partitions 1 --replication-factor 1 (3.9.0기준)

## 2.3 브로커 설정하기
- 모든 구성 제어 바꿀수 있음 근데 대부분 기본값으로 둬도 됨

### 2.3.1 핵심 브로커 매게변수
- 단일서버의 단독실행 브로커가 아니라면 봐야하는 브로커 설정 매개변수
- 다른 브로커들과 함께 클러스터 모드로 작동시키려면 기본값이 아닌 다른 값으로 바꿔줘야 한다.
1. broker.id
   - 호스트별로 고정된 값 사용 권장
2. listeners
   - 리스너 이름이 일반적인 보안 프로토콜이 아니라면 반드시 listener.security.protocol.map tjfwjddmf wkqdkdi gksek.
   - 호스트 이름을 0.0.0.0으로 잡아줄 경우 모든 네트워크 인터페이스로부터 연결을 받게 된다.
   - 1024미만의 포트번호는 루트 권한으로 실행시켜야 하므로 비권장
3. zookeeper.connect
   - 브로커의 메타데이터가 저장되는 주키퍼의 위치
   - chroot경로가 존재하지 않는 경로로 지정될 경우, 브로커가 시작될때 자동으로 생성된다.
     - 대체로 카프카 클러스터에는 chroot 경로를 사용하는 것이 좋다.
     - 주키퍼 앙상블에서 공유 사용가능하기 때문
     - 같은 앙상블에 속하는 다수의 주키퍼 서버를 지정하는 것이 좋다.
     - 특정 서버에 장애가 생기더라도 카프카 브로커가 같은 주키퍼 앙상블의 다른 서버 연결 가능하므로
4. log.dirs
   - default는 log.dir
   - 1개 이상 경로 지정될 경우 브로커는 가장 적은 수의 파티션이 저장된 디렉토리에 새 파티션 저장
   - 사용된 디스크 용량 기준이 아닌 저장된 파티션 수 기준으로 새 파티션의 저장 위치를 배정
     - 다수의 디렉토리에 균등한 양이 저장되지 않는다.
5. num.recovery.threads.per.data.dir
   - 카프카는 설정 가능한 스레드 풀을 사용해서 로그 세그먼트 관리
     - 브로커 정상 시작시 각 파티션의 로그 세그먼트 파일 연다
     - 브로커가 장애 발생 후 다시 시작되었을 때, 각 파티션의 로그 세그먼트를 검사하고 잘못된 부분 삭제
     - 브로커가 종료될 때 로그 세그먼트를 정상적으로 닫음
   - 설정값은 log.dirs에 지정된 로그 디렉토리별 스레드 수 (num.recovery.threads.per.data.dir x log.dir)
6. auto.create.topics.enable
   - 기본설정(아래 상황에 브로커가 토픽 자동 생성)
     - 프로듀서가 토픽에 메시지 쓰기 시작시
     - 컨슈머가 토픽으로부터 메시지 읽기 시작시
     - 클라이언트가 토픽에 대한 메타데이터 요청시
   - 토픽 생성 명시적 관리 원할 경우 이 설정값 false
7. auto.leader.rebalance.enable
   - 이거 키면 파티션 분포 상태 확인하는 백그라운드 스레드 시작 설정 넘어가면 리밸런싱
8. delete.topic.enable
   - 클러스터의 토픽 임의 삭제 막기 원할 경우 false

### 2.3.2 토픽별 기본값
1. num.partitions
    - 새로운 토픽 생성시 몇개의 파티션 갖게 되는지 결정(default 1)
    - 늘리기만 가능
    - 상세 정보가 없다면 파티션 용량을 6GB 미만 유지가 좋다.
2. default.replication.factor
    - 자동 토픽 생성 기능이 활성화되어 있을 경우, 새로 생성되는 토픽의 복제 팩터 결정
    - 복제 팩터 값은 min.insync.replicas설정값보다 1 이상 크게 잡아줄 것을 권장
    - 일반적인 클러스터의 경우 파티션별로 최소한 3개의 레플리카를 가져야 한다.
3. log.retention.ms
    - 메시지 보존 기본값은 1주일
4. log.retention.bytes
    - 메시지 만료 용량
    - 파티션 단위로 적용
    - -1은 영구
5. log.segment.bytes
    - 로그 세그먼트의 크기가 지정된 크기에 다다르면 브로커는 기존 로그 세그먼트를 닫고 새로운 세그먼트를 연다.
    - 기본 1GB
6. log.roll.ms
    - 닫혀야 할때가지 기다리라는 시간 지정
    - 기본적으로 설정되어있지 않음.(보통 크기 기준)
7. min.insync.replicas
   - 2로 잡아주면 최소한 2개의 레플리카가 최신 상태로 프로듀서와 동기화 되도록 할 수 있다.
   - 프로듀서의 ack설정을 all로 잡아 주는 것과 함께 사용
   - 데이터 유실 방지
     - 리더가 쓰기 작업에 응답
     - 리더에 장애 발생
     - 리더 역할이 최근 쓰기 작업 내역을 복제하기 전에 다른 레플리카로 옮겨짐
   - 메시지 유실 방지
8. message.max.bytes
    - 브로커가 쓸 수 있는 메시지 최대 크기 제한
    - 기본값은 1mb(1,000,000)
    - 압축 기준
## 2.4 하드웨어 선택하기

### 2.4.1 디스크
- 많은 클라이언트 SSD, 데이터 많이 저장 HDD

### 2.4.2 디스크 용량
- 10%가량의 오버헤드 고려해야 한다.

### 2.4.3 메모리
- 카프카를 하나의 시스템과 다른 애플리케이션과 함께 운영 권장 않음

### 2.4.4 네트워크
- 10GB 이상 권장

### 2.4.5 CPU
- 브로커의 전체적인 성능에는 영향 but 디스크나 메모리가 더 중요

## 2.5 클라우드에서 카프카 사용하기
- GCP나 Azure에서 사용함

### 2.5.1 Migrosoft Azure
- 디스크를 가상 머신과 분리 관리 가능
- Standard D16s v3가 인스턴스가 작은 클러스터용으로 적합
- 파티션들을 서로 다른 장애 도메인에 분산시킬것을 권고

### 2.5.2 AWS
- m4, r3 추천

## 2.6 카프카 클러스터 설정하기
- 여러대의 브로커를 하나의 클러스터로 구성하는게 이점이 있다. 

### 2.6.1 브로커 개수
- 결정 요소
  - 디스크 용량
  - 브로커당 레플리카 용량
  - cpu 용량
  - 네트워크 용량
- 가장 먼저 고려는 필요한 메시지 저장하는데 필요한 디스크 용량과 단일 브로커가 사용할 수 있는 저장소 용량
- 클러스터가 처리가능한 요청의 양

### 2.6.2 브로커 설정
- 다수의 브로커가 하나의 클러스터를 이루게 하기 위한 설정 조건
  - 모든 브로커들이 동일한 zookeeper.connect 설정값 가짐
  - 클러스터 안의 모든 브로커가 유일한 broker.id 값 가짐

### 2.6.3 운영체제 튜닝
1. 가상메모리
    - 카프카는 시스템 페이지 캐시를 매우 많이 사용하므로 스와핑을 막는것이 최선
    - 스와핑 방지를 위해 스왑 공간 자체 할당하지 않기
    - vm.swappiness설정을 매우 작은 값으로 잡아주는게 좋음
    - 더티페이지도양 줄이기 10보다 작게(보통 5)
    - 브로커에 많은 파티션이 저장되어 있을 경우 브로커는 
      - {파티션수} X ({파티션수} / {세그먼트크기}) + {브로커에 생성된 네트워크 연결수} 의 파일 디스크럽터 필요
    - vm.max_map_count를 매우 큰값으로 올려잡아줄것을 권장 400,000 ~ 600,000
2. 디스크
    - noatime 옵션을 지정해주는거싱 좋다. 
    - 마지막 사용시가인 atime은 사용하지 않는것으로 여김
3. 네트워킹
    - 각 소켓의 송신 수신 버퍼에 할당되는 기본/최대 메모리의 양
    - 합리적 설정값은 128KB, 최대 2MB
   
## 2.7 프로덕션 환경에서의 고려사항

### 2.7.1 가비지 수집기 옵션
- GIGC 설정
  - MaxGCPausMills
    - 가비지 수집 사이클에 있어 선호되는 중단 시간 지정
  - InitiatingHeapOccupancyPercent
    - 수집 사이클을 시작하기 전까지 전체 힙에서 사용 가능한 비율
    - 기본 45

### 2.7.2 데이터센터 레이아웃
- broker.rack 설정

### 2.7.3 주키퍼 공유하기 
- 컨슈머 그룹 멤버나 카프카 클러스터 자체에 변동이 있을 때만 주키퍼 쓰기가 이뤄짐
- 하지만 설정에 따라 컨슈머워 주키퍼가 직접 연관될 수 있음.
  - 오프셋 커밋, 카프카 사용, 커밋 사이 간격 조정
- 합리적 오프셋 커밋 간격은 1분
- 다수의 카프카 클러스터가 하나의 주키퍼 앙상블을 공유하는 경우를 제외하면 다른 애플리케이션과 주키퍼 앙상블 공유는 피하는것이 좋음