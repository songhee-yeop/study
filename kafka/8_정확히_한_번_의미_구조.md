# 8 '정확히 한 번' 의미 구조
- 카프카의 '정확히 한 번' 의미 구조는 두 개의 핵심 기능
    - 멱등성 프로듀서
    - 트랜잭션

## 8.1 멱등성 프로듀서
- 멱등성: 여러번 실행해도 한 번 실행한것과 같은 결과 나오는 것

### 8.1.1 멱등성 프로듀서의 작동 원리
- 파티션별로 추적되어야 하는 시퀀스 넘버의 수를 제한하고 싶다면
  - max.in.flights.requests.per.connection 설정값 5 이하로 잡기
- 프로듀서 장애후 재시작하게 되면 초기화 과정에서 카프카 브로커로부터 프로듀서 ID를 생성 받는다.
  - 원래는 완전히 새로운 id

### 8.1.2 멱등성 프로듀서의 한계
- 멱등성 프로듀서는 프로듀서 자체의 재시도 매커니즘에 의한 중복만 방지할 뿐 그 이상은 하지 않는다.

## 8.2 트랜잭션

### 8.2.1 트랜잭션 활용 사례
- 금융 애플리케이션
- 챗봇

### 8.2.2 트랜잭션이 해결한느 문제
- 잘못될 사항?
- 애플리케이션 크래시로 인한 재처리
  - 애플리케이션의 역할은 결과를 출력 토픽에 쓰기, 읽어온 메시지의 오프셋 커밋하기
  - 출력에 썼는데 입력 오프셋 커밋 전에 에러?
    - 컨슈머는 새로 할당된 파티션의 마지막으로 커밋된 오프셋으로부터 메시지 읽음
    - 결과 역시 출력 토픽에 다시 쓰임 -> 중복
- 좀비 애플리케이에 의해 발생하는 재처리
  - 스스로가 죽은 상태인지 모르는 컨슈머 -> 좀비

### 8.2.3 트랜잭션은 어떻게 '정확히 한 번'을 보장하는가?
- 원자적 다수 파티션 쓰기 기능 도입
  - 트랜잭션적 프로듀서 사용
- read_committed모드로 잡혀있을 경우 아직 진행중인 트랜잭셙이 청므으로 시작된 시점 이후에 쓰여진 메시지는 리턴되지 않음
- 트랜잭션 프로듀서가 트랜잭션 과정의 일부로 오프셋을 쓰므로 오프셋 커밋 기능은 꺼야 함
- 
### 8.2.4 트랜잭션으로 해결할 수 없는 문제들
- 스트림 처리에 있어서 부수효과
  - ex) 이메일 전송
- 카프카 토픽에서 읽어서 데이터베이스에 쓰는 경우
- 데이터베이스에서 읽어서 카프카에 쓰고 여기서 다시 다른 데이터베이스에 쓰는 경우
- 한 클러스터에서 다른 클러스터로 복제
- 발행/구독 패턴